% \iffalse meta-comment
% (c) 2021 Vincent Kuhlmann
% 
% \fi
% \iffalse
%<*driver>
\ProvidesFile{highlightlatex.dtx}[2021/03/19 highlightlatex v1.0.0 + Dev]
\NeedsTeXFormat{LaTeX2e}[1994/06/01]

\documentclass{ltxdoc}

\usepackage[margin=2.54cm]{geometry}
\usepackage{graphicx}
\usepackage{parskip}
\usepackage{listings}
\usepackage{adjustbox}
\usepackage{soul}
\usepackage{hyperref}
\usepackage{xcolor}

\expandafter\newif\csname ifuseownpackage\endcsname
\useownpackagetrue

\ifuseownpackage
    \usepackage{highlightlatex}
    \updatehighlight{
    	name = default,
    	add = {
    		\defaultgobble, \colorlet, \includegraphics, \maketitle, \mycommand,
			\tableofcontents, \figref, \color
	    },
		%
    	name = hll,
    	color = orange!90!black,
    	add = {
    		\hll, highlightblock
    	},
		%
    	name = hllOth,
    	color = red!90!black,
    	add = {
    		\useblock, \consumeblock, \updatehighlight, saveblock
    	},
		% 	
    	name = vert,
    	color = red,
    	add = {
    		|
	    }
	}   
\else
    \let\hll\lstinline
    \lstnewenvironment{highlightblock}[1][]
    {%
        \lstset{#1}%
    }{}%
    \lstset{tabsize=2,escapeinside=~}
\fi

\newcommand\fhref[2]{%
	\href{#1}{#2}\;\footnote{\,\url{#1}}\,%
}

\newlength\centerlabelledwidth
\newlength\centerlabelledminleft
\def\centerlabelledlabel{}
\setlength\centerlabelledminleft{5em}
\expandafter\newif\csname ifshowcasecenter\endcsname

\makeatletter
\define@key{centerlabelled}{label}{%
	\def\centerlabelledlabel{#1}%
}

\define@key{centerlabelled}{width}{%
	\setlength\centerlabelledwidth{\dimexpr #1\relax}%
}

\define@key{centerlabelled}{frac}{%
	\setlength\centerlabelledwidth{\dimexpr #1\textwidth\relax}%
}

\define@key{centerlabelled}{left}[]{%
	\showcasecenterfalse
}

\define@key{centerlabelled}{center}[]{%
	\showcasecentertrue
}

\define@key{centerlabelled}{minleft}{%
	\setlength\centerlabelledminleft{#1}%
}
\makeatother

\newlength\showcaseleft

\newenvironment{centerlabelled}[1][]{%
	\setlength\centerlabelledwidth{\linewidth}%
	\setkeys{centerlabelled}{#1}%
	\setlength\showcaseleft{\dimexpr(\linewidth-\centerlabelledwidth)/2\relax}%
	\ifshowcasecenter
		\ifdim\centerlabelledminleft>\showcaseleft\relax
			\showcasecenterfalse
		\fi
	\fi
	%
	\unless\ifshowcasecenter
		\setlength\showcaseleft\centerlabelledminleft
		\ifdim\dimexpr\textwidth-\centerlabelledminleft\relax<\centerlabelledwidth\relax
			\setlength\centerlabelledwidth{\dimexpr\linewidth-\centerlabelledminleft\relax}%
		\fi
	\fi
	%
	\par\penalty 10000%
	\hspace{\showcaseleft}%
	\adjustbox{raise=-6pt,lap=-\width-1em}{\setulcolor{red}%
	\expandafter\ul\expandafter{\expandafter\textsc\expandafter{\centerlabelledlabel}}}%
	\begin{minipage}[t]{\centerlabelledwidth}%
	\lstset{framexleftmargin=0.25em}%
}{%
	\end{minipage}\par%
}

\newenvironment{showcase}{%
	\begin{centerlabelled}%
}
{%
	\end{centerlabelled}
}

\def\sectionautorefname{Section}
\def\subsectionautorefname{Subsection}


\begin{document}
    \DocInput{\jobname.dtx}
\end{document}
%</driver>
% \fi
%
% 
% \newbox\cmdintitle
% \setbox\cmdintitle=\hbox{\hll|highlightlatex|}
% \setbox\cmdintitle=\hbox{\adjustbox{height=2.0\height}{\usebox\cmdintitle}}
% \def\defaultgobble{10}
% 
% \title{Package \usebox\cmdintitle{} manual}
% \author{
%     Vincent Kuhlmann\\
%     \texttt{vincent.kuhlmann@hotmail.com}
% }
% 
% 
% \maketitle
% \begin{abstract}
%     This package provides colored syntax highlighting for \LaTeX{} source code, without aid from
%     outside \LaTeX. This is in response to the general trend that people often fall back to verbatim
%     for displaying code. This package aims to make typesetting good looking \LaTeX{} source code accessible.
%     For this, it builds further on the generic `listings' package. An example output is
%     shown in \autoref{fig:demoOutput}\,.
% \end{abstract}
% 
% \bigskip
% 
% \begin{center}
%     {\small\textbf{Repository}}
% 
%     \url{https://github.com/vkuhlmann/highlight-latex}
% \end{center}
% 
% \vspace{5\baselineskip}
% 
% \begin{figure}[htbp]
%     \centering
%     \rule{2cm}{1pt}
% 
%     \bigskip
%     \IfFileExists{demo/demo.pdf}{
%         \includegraphics[width=\textwidth,trim=1cm 1cm 1cm 1cm, clip]{demo/demo.pdf}
%     }{
%         \IfFileExists{demo.pdf}{
%             \includegraphics[width=\textwidth,trim=1cm 1cm 1cm 1cm, clip]{demo.pdf}
%         }{
%             [Generate \texttt{demo.pdf} for an illustration here]
%         }
%     }
%     \caption{Output of `demo.tex'.}\label{fig:demoOutput}
%     \bigskip
%     \rule{2cm}{1pt}
% \end{figure}
% 
% \vfil
% 
% \pagebreak
% \tableofcontents
% \pagebreak
% 
% \section{Getting started}
% 
% After having added the package, you can add LaTeX in two ways.
% 
% \subsection{Inline style}
% 
% \begin{showcase}[label=example]
%     \begin{highlightblock}
%         Your file begins with a line of the form \hll茕镢蹴孱翥灬篌圯澡篑踽蝈怛徙脲趔苠钿栝玷扉玷翕祜汶苠钿箬秣汜箦澡骈蝮铒瞽箴徙汨狎徙翦骘祆秣轭莒篝轭扉铄荑祆溴扉黹趔翳狎珲礤铘麸翳轶泔眄犷洚荏踱箦泗轱铥蚂镢篝戾茆彗轭箬秣汜箦垤徕屐藉犴痨遢茆彗轭栝玷扉玷翕祜汶亠躜忉箝滹沲礤铘铒祜镫扉脲茆彗轭栝玷扉玷翕祜汶坨镡忪褰摧茕镢蹴孱翥灬篌坩答狃弪蓰狎糸沆妪茆彗轭滹沲礤铘儒祆黠蜢洹苠钿滹沲礤铘苠钿栝玷扉玷翕祜汶苠钿栝玷扉玷翕祜汶苠钿箬秣汜箦燥痱弼孱轭溴铘狒轱镦秕荑祆栝玷扉玷翕祜汶ㄨ弪镱翎猢麸忮箬秣狍疳螋镦翳泔溴翳荑祆顼忖戾疳蜥礤翦篝蜷痼翳屙镦娈徐狴狎秕钿鏖翳轸躅糸弼弪翳轭祜镫蜷玷舢蝈泔眄孱麸箦翳轶鲠祯珈镡犰禊躞轭荑祆茕彐茕彐狨祠顼忖戾昌亠汜篝殪秭弪蜷溴轸镱疱颦忪镢忉箝蟋殒铄沐篌狎澡弪狎箝趱狒轱铙翳忪镢泔蹯蝓秕镦翳疳珏骘屮犴痨秕铄邃麸筢鲥翳忪镢骘躞轭忮犴弪滹沲礤铘箦茚豸矧彐箦愫骝徵┊深翳狒汜箦翳铒蝽犰骢祆鏖漪镦箪殇轶狍篚礤洮怩秕黹玷麽铘麸躞轸轭箪殇鏖翳眭祠轲戾泔祯眍螽渝翳荑祆扉铄鏖漪椟镱翳荑祆栝玷扉玷翕祜汶澡轶汜忮骝徙糸镱镦翳麸翎箪殇鏖漪狯衢灬忪瀣荑祆爱盾翦赭殇翳轶栋堀镦翳鏖漪璎矧犷徕箫祯翦鲠祯瀣扉脲荑祆卑屙麒殂箦屙麸羼踽舶汨狎徙翦蝮澡弪狎盹蝈脲秕汜痱秭殇瀹描邈翳苕栩彐梏麴蠛鼢鳟泗犷矧绡痣绡扉篝轭珞荑祆扉篝轭珞疳汶徵滹沲礤铘狒轱铨骘镳糸镱狯衢灬忪麸翳荑祆祗綮轶糸铉孱鲩蝻铐孱犷荑祆祗趔弭泔眄犷洚茴鬻怙荃痂怙荏弭怙荃痂怙杰桠秫荑祆荃痄狒彖殓桁殓梏荏弭怙荃痂怙杰桠秫茚潢躞翕秫桢殓梏奖窜桢殓梏荃箦怙荃痂怙荏邈糸镱弁徙蝻荇屮翕徙塍灬箬躔溽翦栝玷扉玷糨荛珙矧弩疳沐歪泸荇屮矧痄骟趄轭琨荃箦怙荃痂怙荇屮翕徙塍灬箬躔溽翦栝玷扉玷酏荏踱箦泗轱铥龄溟铉泔眄犷麸栝玷扉玷糸铉蝓戾蛮溴驷蹯衄镱禊箫礤提藻泔眄犷潴鏖祆忮栝玷扉玷翦轭忪蹂涉翳弪狎雉桢蝮秕铄邃扉脲荑祆荇徕戾镦泔铘孱趔犷荑祆苕殓蝈纥躔溽翦翳栝玷扉玷糸铉蝓戾蠛茆彗轭箬秣汜箦垤徕屐锦箦茆彗轭栝玷扉玷翕祜汶荃痄狒彖殓桁殓梏钺礤溴驷蹯衄徜荇徕戾镦泔铘孱趔苕殓蝈苠钿栝玷扉玷翕祜汶苠钿箬秣汜箦澡汨犷珏鏖祆镱禊徭驽泗泔溴徭翦轸蝈泔眄孱轶篚轭荑祆躔溽翦栝玷扉玷酎轭秕痱遽礅戾ㄢ彐矧翳荑祆茆彗轭滹沲礤铘┊深箫礤箝趱狒轱铙秕黹玷麽铘麸汨犷珏翳轭珞黹洵滹沲礤铘澡狒痫篌殁戾麸锂荏踱箦泗轱铥悯篝镯栝玷扉玷糸铉蝓戾簖荏踱篚怏邈糸镱砒犴痨妪馏箬秣轭荑祆溴盹翦秕汜瘐犷泔眄犷矧脲黠蜾秕麽铘麸栝玷扉玷轭溟骀弪孱泔祜虍亠滹翳轶鏖翳茆彗轭箬秣汜箦垤徕屐藉犴痨遢茆彗轭栝玷扉玷翕祜汶荃痄狒彖殓桁殓梏澡钺礤犰祜黧秕麸盹溟纟翳篝戾灬翦虍钺礤箴雉扉玷衄泔祜矧犷珏徜荇徕戾镦泔铘孱趔苠钿栝玷扉玷翕祜汶苠钿箬秣汜箦亠汜躞翳荑祆泔祜螯簌铘狲骘溴筱蜷忾铉泔祜蝮狍麇祆涉秕骈钿翳矧犷珏麸怛殓梏秕汜蝈痨徙轸鏖翳荑祆矧犷珏」啊忪徙朦拱堀矧犷珏蝈磲轭轭轶忪徙氘骑盹蝈轭骘蝽狒轱镱泔祜溴骈铋糸镱犷钺礤蝈驽麸苕栩彐梏麴蠛孱鏖腴怙镫螽矧绡鏖腴提藻丿蔑祜蝮提藻丿蔑祜蝮镱组腴怙镫簖荏踱篚怏邈糸镱羽邈殒殂狒轱铨澡狎珲礤铘麸荑祆荃痄狒彖殓桁殓梏轶脲鲠祯扉篝隋狎痱镢弩箦箦聃孱糸犰禊骑屮犴痨瀣躞荑祆泔祜螯忮骘蝈荑祆徜潼蜥翳弪翳犷徭翦轸犷脲汜狃疱狎眭祠轲戾糸礤螽裴汨镱鏖祆忮痱镢弩箦洚亠汜礤蜱犷赭荑祆荃痄狒彖殓桁殓梏轭镱瀹物铄邃麸沆矬犷蝈镳孱荑祆荃痄狒彖殓桁殓梏骘遽汨栝玷扉玷糸铉蝓戾亠黹玷忮翦眇翦麸徜忪犷扉铄骘沆狎轸翳狒礤犷铄疳蜥珧狃麸提藻噩滹瞌滹轸深篝遽洮牾篝瘐扉铄鏖翳镱禊荑祆堀箝珙羽徙轭鏖翳轭翳狎珲礤铘轶镦翦轵蝈戾鲠铘涉秕铄邃泔眄轭翳鲠祯瀣篚蝌秕钿秕鲠祯鏖翳怛徙弩茆彗轭扉篝荛翦黹钿孱舡莒彐繇狎玳荏弭戾铉翳荛翦眢屦卑痿荛翦碥翦翕纣钺礤莛狎茴镡蝈犭抿遽翦矧盹溟骈弩钺礤蝓戾澡轶脲轶镳糸镱犰澡溴驷蹯脲狎荑祆溴驷蹯酎麒殂轭沆蹁弩怩钽镦忉箝泔眄犷潴犷栳怡溴驷蹯溽螂忪蹂泔祜颥犷荑祆篝蝓泗躜妩麒殂泔铙轶趔镦荑祆茆彗轭犷荑祆苠钿犷痱轭趔翳屙轭扉玷忪蹂荛翦碥翦翕纣沆狍箫骀箦酏莛狎茴镡蝈犭渝趔翳荑祆扉篝轭珞沆狍箫骀箦磲铛犰禊则麸狯镩翳轶阵荇屮翕纣钺礤麸蝈驽麸屮轶糸铉蝓戾轭篝遽洚荛翦碥翦翕纣徜潺莛狎茴镡蝈犭龄潴泔眄犷ㄜ桁禳茼泔眄犷潼矧脲黠蜾ㄜ桁禳乳↑麸翳沲蝌孱蝓戾澡鲠祯汜泔铘衢眭祠轲戾鲠祯弩怡镳孱轭怛徙弩犷泔眄箦疳蜥糸铉鲠祯弩鏖翳轭翳屙荛翦碥翦翕纣蝈盹鲥莛狎茴镡蝈犭义盹鲥泔眄犷潴矧脲黠蜾骝镯翳沲蝌孱蝓戾澡鲠祯汜泔铘衢眭祠轲戾鲠祯弩怡镳孱轭怛徙弩犷泔眄箦疳蜥糸铉鲠祯弩鏖翳轭翳屙荛翦碥翦翕纣沆遽螨莛狎茴镡蝈犭义盹鲥犰泔眄犷潴犷脲黠蜾骝镯翳沲蝌孱蝓戾阵鏖翳秕鲠祯瀣骘屮犴痨茆彗轭箬秣汜箦垤徕屐藉犴痨遢茆彗轭栝玷扉玷翕祜汶坨镡忪褰贝荃痄狒彖殓桁殓梏钺礤溴驷蹯衄沆遽苠钿栝玷扉玷翕祜汶苠钿箬秣汜箦荛翦碥翦翕纣泔祜螨莛狎茴镡蝈犭羽邈殒殄泔祜骘翳蝓戾篷蹰鲠戾铘麸箴邈殒轭荑祆篝戾轭篝遽洮鏖翳鲠祯荑祆茔镬矧鲠祯妪麒弪荑祆鲠祯妩轶翳鲠祯骘翳荇屮翕纣泔祜螨脲语荑祆泔祜蚪蝈潼犷荑祆篝戾杰泔祜螓蝈潺狎羼蹰鲠戾铘荛翦碥翦翕纣篝戾莛狎茴镡蝈犭羽邈殒殄篝戾骘翳蝓戾蝓戾汜栳鲥镱禊镱篝戾涉秕箴邈殒篝戾徭翦荑祆徜潼矧荑祆蝈盹鲥翳轶篝狎趔铄躅钺礤洎蝓戾深痱徙糸沐翳镱禊篝戾麒殂鏖祆痱镡徕禊黠螂骘秕轶牾篝泔祜虍骑翳狒躞轭翳嚆镬矧脲轶牾篝忾遽箝弪犷铄狒弪迈桢秕栳鲥翳镳糸镱麸箦麒狒弼弪篝戾秕麽铘憨苠钿扉篝荏邈糸镱庆镡犰箦趑轭珞澡弪狎箫礤珈镡犰疳蜥礤翦蝮轭鲲祧邃轭翳狃疱狎犷沐茆彗轭箬秣汜箦垤徕屐斤鲥蝣殄鬏茆彗轭栝玷扉玷翕祜汶坨镡忪褰卑茔镬矧戾酐沲蜢买徙脲趔蝈洹蛋♀祯妪茔镬矧戾酐篑踽蝈买徙脲趔忪蹂〉啊麒轸妪茔镬矧戾酐泔溴箩汶珧秕钿珧狴”啊麒轸妪茔镬矧戾酐泔眄孱酏珧邋睢窗♀灬汶茕彐茕彐狨祠顼忖戾褒苠钿栝玷扉玷翕祜汶苠钿箬秣汜箦裴汨扉铄汜忮箦轭溴疱钿孱镦遽汨雉桢颥犷遽汨箬秣轸溴驷蹯鲠祯瀹澡弪狎疳汶徵镳糸镱秕汜躞狍麇祆茆彗轭扉篝荛翦黹钿孱舡莒彐繇狎玳荏弭戾铉翳荛翦眢屦卑痿荛翦碥翦翕纣骝犴妪ㄤ彐狨祠荑祆扉铄簏┸疳蜍铒怛遽羽邈殒殄翳骝犴秕麽铘狎秕钿泔溴往驷鲲蜷翦狎荑祆扉铄簏犷荑祆铒铄描邈翳苕栩彐梏麴蠛鼢鳟泗犷矧绡痣绡扉篝轭珞扉篝轭珞疳汶徵滹沲礤铘狒轱铨骘犰痫篌殁殪轸殄螽荛翦碥翦翕纣铒骝犴妪躞鏖翳秕鲠祯濠莛狎茴镡蝈犭篷蹰鲠戾铘麸荑祆骝犴褰铒铄荛翦碥翦翕纣篝戾犷麒弪妪躞鏖翳秕鲠祯濠莛狎茴镡蝈犭霄弪蜷溴翳溴驷蹯忮栳鲩矧翳狒荑祆篝戾篝狎趔铄篝戾徭翦泔眄犷潴扉脲荑祆徜潼犷荑祆蝈盹鲥苠钿扉篝荏邈糸镱乞徵殪怛遽腴铉箝趱狒轱铙扉脲忮犴弪骝犴弩莒徕屐箦愫骝徵阻孱疳篌轭泔眄犷狎珲礤铘狎秕钿矧篝矧轭孱鲩蝻铐孱泔铘孱衄提藻轭翦蝠蝈趔犰汨狎徙翦蝮澡轶轭沆蹁弩箦彘铉荑祆茼犭弭轸戾轭荑祆≤桁禳茼犭弭轸戾狍蝈犰泔眄犷洚燥痱弼孱翳轶忮栳鲩矧弼弪翳轭骝镯荑祆荟弪恻荛骀犰箦苕麸翳荑祆鲥蜮狒轫孱鲩蝻铐孱衄麸翳荑祆扉篝轭珞疳汶徵麒殂翳轶疳汶徵溴疱钿镱翦眇矧狎殪汨犷珏翳轭翦蝠蝈翎糸镱镦汨狎徙翦蝮翳狒狎篝殪麸忮蝈徜澡忪徙塍灬箬忮骘蝈磲脲糸綮轭荑祆≤桁禳茼犭弭轸戾鏖祆忮蝈徜狍嚓躞翦臾ㄡ荇屮糸酐戾趑弪翦汨铋汜祆┊阻孱泔铘孱珏趔轭翦蝠蝈翦遽蜢扉脲翳荑祆骝犴妩孱鲩蝻铐孱轭荑祆忮犴弪滹弩翳轶趄殂汜瞌忮滹铄犷盹蝈深篝遽洮秕彘翳弪铄邃麸苠眇棼弩汜疱泔溴矧苠眇棼痱瀛痱镢弩簖翳泔溴秕趔殇骝徵殪怛遽腴铉箝趱狒轱町朋汜痖铉轶滹铄怡痱邈邃轭箴邈獒汨狎徙翦蝮鏖翳忉汶箪狍璁骑屮犴痨瀣荑祆≤桁禳茕镢蹴孱翥灬篌圯忮泔礤荑祆≤桁禳苘≤桁臁滹沲礤铘沆狍筵蒈荦‘骑灬蜱泔溴忪镢塍翳轶轶躅溴箝蜥忪瀹澡弪彐矧瀣翳疳汶徵痱秭殇弩骘泔眇犷轱麸翳荑祆栝玷扉玷翕祜汶孱鲩蝻铐孱艉篚蝌秕钿轸鏖翳荑祆筢鲥忪镢朦孱鲩蝻铐孱麒殂翎脲箝铉戾狎珲礤铘钺礤麸狍箝珙轸骑屮犴痨搴茆彗轭箬秣汜箦垤徕屐藉犴痨遢茆彗轭栝玷扉玷翕祜汶坨镡忪褰卑茆彗轭筢鲥忪镢臊忉箝沔殓躜妪茆彗轭栝玷扉玷翕祜汶垤轭鬻殇翳桨盾翦赭殇翳茆彗轭骈珲蝈荛钽祯溴珧狃栝泱埙殇翳桨管扉铄鏖漪栎睐徐雉痄纨茔狃糸镱往痨雉莒徕屐骈绾睐痨雉苠钿骈珲蝈苠钿栝玷扉玷翕祜汶
%         \end{saveblock}
%     \end{highlightblock}
% \end{showcase}
% 
% 
% Do this outside a fragile breaking situation. (For the \hll|frame|-environment example, that means
% just before the \hll|frame| for example.) Then, where you want to use it, use
% \hll|\useblock{basicfigure}|, where the argument
% is the name used during saving.
% There is also a variant \hll|\consumeblock{basicfigure}|. If you save
% many blocks, these will all remain loaded in memory till your PDF has fully generated. The
% \hll|\consumeblock| works like \hll|\useblock|, except the saved block is deleted from memory after
% its use. Note this can also result in unexpected behavior, for example animations in a beamer frame
% might need the code line to be executed multiple times. Use \hll|\useblock| when you can't
% guarantee the last use of a block.
% 
% There is a separate demo for fragile breaking situations. You can find it at
% \hll|deamerdemo/deamerdemo.tex|.
% 
% \section{Adding extra space}
% 
% By default, \hll|highlightlatex| follows an approach where it minimizes spacing. This gives you full
% control over how tight or spacious your document looks. Just use commands like \hll|\medskip| to add
% extra spacing. The package doesn't currently include an option to do it everywhere automatically.
% 
% \section{License \& Credits}
% 
% The package is available under MIT License. See \textsc{license}.txt.
% 
% Thanks for minor fixes:
% 
% gemmaro
% 
% \rule{5cm}{0.4pt}
% 
% For any bug, feature request, unclarity, or whatever else related to this package, you're welcome to
% open an issue or pull-request. Issues can be opened on
% 
% \begin{showcase}[label=url]
%     \begin{highlightblock}[gobble=10]
%         \url{https://github.com/vkuhlmann/highlight-latex/issues}%     \end{highlightblock}
% \end{showcase}
% 
% Thanks for contributing!
% 
% 
%
% \section{Implementation}
%
%    \begin{macrocode}
\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{highlightlatex}[2021/03/17 highlightlatex v1.0.0 + Dev]

%% Repository: https://github.com/vkuhlmann/highlight-latex
%% Version: v1.0.0 + Dev

%% Copyright (c) 2021 Vincent Kuhlmann
%% 
%% Permission is hereby granted, free of charge, to any person obtaining a copy of
%% this software and associated documentation files (the "Software"), to deal in
%% the Software without restriction, including without limitation the rights to
%% use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
%% the Software, and to permit persons to whom the Software is furnished to do so,
%% subject to the following conditions:
%% 
%% The above copyright notice and this permission notice shall be included in all
%% copies or substantial portions of the Software.
%% 
%% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
%% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
%% FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
%% COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
%% IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
%% CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

\RequirePackage{listings}
\RequirePackage{xcolor}

\RequirePackage{xkeyval}
\RequirePackage{etoolbox}

%% Snippet source:
%% https://tex.stackexchange.com/questions/406015/defining-macro-gsetlength-as-global-setlength-reliable
\gdef\gsetlength#1#2{%
    \begingroup
        \setlength\skip@{#2}%
        \global#1=\skip@
    \endgroup
}


\def\@highlight@frame{none}
\newlength{\hll@offset@fixskip}
\setlength{\hll@offset@fixskip}{0pt}

\newif\ifhllStyleAnywhere
\newcommand\defaultgobble{0}
\newif\ifhllDebugFrame
\newlength\hllBeforeSkip
\setlength\hllBeforeSkip{2pt}
\newlength\hllAfterSkip
\setlength\hllAfterSkip{0pt}

%    \end{macrocode}
% \subsection{Package options}

%    \begin{macrocode}
\DeclareOptionX{frame}{
    \setframe{#1}
}

\DeclareOptionX{noframe}{
    \setframe{none}
}

\DeclareOptionX{debugframe}{
    \hllDebugFrametrue
}

\def\setframe#1{%
    \def\frameval{#1}%
    \ifx\relax#1\relax
        \def\frameval{lines}%
    \fi
    \def\linesvalue{lines}%
    %
    \xdef\@highlight@frame{\frameval}%
    %
    \ifx\frameval\linesvalue
        \gsetlength{\hll@offset@fixskip}{6pt}%
    \else
        \gsetlength{\hll@offset@fixskip}{0pt}%
    \fi
}

\DeclareOptionX{styleanywhere}{
    \hllStyleAnywheretrue
}

\newcounter{hlltabsize}
\setcounter{hlltabsize}{4}

\DeclareOptionX{tabsize}{
    \setcounter{hlltabsize}{#1}
}

\DeclareOptionX{gobble}{
    \def\defaultgobble{#1}
}

\DeclareOptionX*{\PackageWarning{highlightlatex}{`\CurrentOption' ignored}}
\ExecuteOptionsX{frame=lines}

\ProcessOptionsX\relax

%    \end{macrocode}
% \subsection{Initialization}

%    \begin{macrocode}
\colorlet{curlyBrackets}{red!50!blue}
\colorlet{squareBrackets}{blue!50!white}
\colorlet{codeBackground}{gray!6!white}
\colorlet{comment}{green!40!black}

\colorlet{accDefault}{blue!90!black}
\definecolor{accStructure}{RGB}{0,149,255}

\colorlet{accentB}{green!60!black}

\catcode`\{=11
\let\myopenbrace={
\catcode`\{=1

\catcode`\}=11
\let\myclosebrace=}
\catcode`\}=2

\lstdefinelanguage{ColoredLaTeX}
[LaTeX]{TeX}{
    backgroundcolor=\color{codeBackground},
    keywordstyle=\bfseries\color{accDefault},
    basicstyle=\footnotesize\ttfamily,
    commentstyle=\color{comment},
    numbers=none,
    tabsize=\thehlltabsize,
    mathescape=false,
    alsoletter={$@_!|?$},
%
    classoffset=0,
    keywordstyle=\color{accDefault},
    texcsstyle=*\color{accDefault},
    moretexcs={subsection,thesubsection,thesection,theoremstyle},
    deletetexcs={begin,end},
%
    classoffset=1,
    keywordstyle=\color{accStructure},
    texcsstyle=*\color{accStructure},
    moretexcs={begin,end},
%
    classoffset=2,
    escapeinside=~,
%    
    classoffset=0,
    %literate={textA}{textB}{3}%
    %https://tex.stackexchange.com/questions/172945/coloring-in-listing
    literate={\{}{{\textcolor{curlyBrackets}{\myopenbrace}}}{1}
        {\}}{{\textcolor{curlyBrackets}{\myclosebrace}}}{1}
        {[}{{\textcolor{squareBrackets}{[}}}{1}
        {]}{{\textcolor{squareBrackets}{]}}}{1}%
    %        {(}{{\textcolor{delimiterColor}{(}}}{1}
    %        {)}{{\textcolor{delimiterColor}{)}}}{1}%
    %texcsstyle=\color{blue}
}
\lstset{language=ColoredLaTeX}

\def\hll@assignlabel#1#2{%
    \expandafter\gdef\csname hll@labeltoclassoffset@#1\endcsname{#2}%
}

\hll@assignlabel{default}{0}
\hll@assignlabel{structure}{1}

%    \end{macrocode}
% \subsection{Options}
%
%    \begin{macrocode}
\newcommand{\hllDelimDollar}[1][\color{green!40!black}]{%
    \lstset{
        classoffset=2,
        moredelim=**[s][#1]{$}{$},
        classoffset=0
    }%
}

\newcommand{\hllDelimParen}[1][\color{green!40!black}]{%
    \lstset{
        classoffset=2,
        moredelim=**[s][#1]{\(}{\)},
        classoffset=0
    }%
}

\define@key{hllglobal}{tabsize}{%
    
}

\define@key{hllglobal}{frame}{%
    
}

\define@key{hllglobal}{noframe}{%
    
}

\define@key{hllglobal}{mathdollarstyle}{%
    
}

\define@key{hllglobal}{mathdollarcolor}{%
    
}

\define@key{hllglobal}{mathparenstyle}{%
    
}
\define@key{hllglobal}{mathparencolor}{%
    
}

\define@key{hllglobal}{gobble}{%
    
}

\define@key{hllglobal}{alsoletter}{%
    
}

\define@key{hllglobal}{backgroundcolor}{%
    
}
\define@key{hllglobal}{bracketcolor}{%
    
}
\define@key{hllglobal}{bracecolor}{%
    
}




%    \end{macrocode}
% \subsection{Block and inline markup}
%
%    \begin{macrocode}
\newcommand{\hllPrepareBlock}{%
    \lstset{framesep=0.1cm,framerule=0.6pt}%
    \def\setHighlightFrame##1{%
        \lstset{frame=##1}%
    }%
    \expandafter\setHighlightFrame\expandafter{\@highlight@frame}%
    \lstset{belowskip=0pt,aboveskip=0pt,belowcaptionskip=0pt,gobble=\defaultgobble}%
    \setlength\parskip{0pt}%
    \setlength\parindent{0pt}%
}

\lstnewenvironment{highlightblock}[1][]
{%
    \vspace{\hllBeforeSkip}%
    \begingroup
    \hllPrepareBlock\lstset{#1}%
}{%
    \nointerlineskip
    \endgroup
    \vspace{\hllAfterSkip}%
}

\lstnewenvironment{hllblock}[1][]
{%
    \vspace{\hllBeforeSkip}%
    \begingroup
    \hllPrepareBlock\lstset{#1}%
}{%
    \endgroup
    \vspace{\hllAfterSkip}%
}

\def\hll{\lstinline}

%    \end{macrocode}
% \subsection{Block saving}


%    \begin{macrocode}
\newenvironment{saveblock}[1]{%
    \expandafter\ifx\csname @codebox@#1\endcsname\relax
        \expandafter\newbox\csname @codebox@#1\endcsname\relax
    \fi
    %
    %% The trick from latex/base/latex.ltx
    \edef\@bracehack{%
        \endgroup
        \expandafter\setbox\csname @codebox@#1\endcsname\vbox{%
            \begingroup\aftergroup}%
        \def\noexpand\@currenvir{\@currenvir}%
        \def\noexpand\@currenvline{\on@line}}%
    \@bracehack
    \begingroup\vspace{\hll@offset@fixskip}
    \ignorespaces%
}{%
    \endgroup
}

\newcommand\useblock[1]{%
    \ifhllDebugFrame
        \par
        {%
            \setlength{\fboxsep}{0pt}%
            \fcolorbox{orange}{red}{\expandafter\usebox\csname @codebox@#1\endcsname}%
        }%
        \par
    \else
        \par\expandafter\usebox\csname @codebox@#1\endcsname\par
    \fi
}

\newcommand\consumeblock[1]{%
    \ifhllDebugFrame
        \par
        {%
            \setlength{\fboxsep}{0pt}%
            \setlength{\fboxrule}{1pt}%
            \fcolorbox{orange}{red}{\leavevmode\expandafter\box\csname @codebox@#1\endcsname\relax}%
        }
        \par
        \expandafter\let\csname @codebox@#1\endcsname\relax
    \else
        \par\leavevmode\expandafter\box\csname @codebox@#1\endcsname\relax\par
        \expandafter\let\csname @codebox@#1\endcsname\relax
    \fi
}

%    \end{macrocode}
% \subsection{Macro \textbackslash updatehighlight}


%    \begin{macrocode}
\def\hll@update@label{}

\newcounter{hll@update@state}

\newcounter{hll@update@nextclassoffset}
\setcounter{hll@update@nextclassoffset}{5}

\newcounter{hll@update@classoffset}

\def\hll@update@fixclassoffset{%
    \ifnum\value{hll@update@state}<1\relax
    \setcounter{hll@update@classoffset}{\thehll@update@nextclassoffset}%
    \stepcounter{hll@update@nextclassoffset}%
    \setcounter{hll@update@state}{1}%
    \fi
}

\newcommand{\updatehighlight}[1]{%
    \setcounter{hll@update@state}{-1}%
    \gdef\hll@update@label{}%
    \setkeys{updatehighlight}{#1}%
    %
    \lstset{classoffset=0}%
}

%    \end{macrocode}
% \subsubsection{Key `name'}


%    \begin{macrocode}
\define@key{updatehighlight}{name}{%
    \hll@update@setlabel{#1}%
}

\def\hll@update@setlabel#1{
    \gdef\hll@update@label{#1}%
    \expandafter\def\expandafter\@capturedlabel\expandafter{\csname hll@labeltoclassoffset@#1\endcsname}%
    \expandafter\unless\expandafter\ifx\@capturedlabel\relax\relax
        % Label exists
        \edef\@val{\@capturedlabel}%
        \setcounter{hll@update@classoffset}{\@val}%
        \setcounter{hll@update@state}{1}%
    \else
        % Allocate new label
        \edef\@val{\thehll@update@nextclassoffset}%
        \setcounter{hll@update@classoffset}{\@val}%
        \stepcounter{hll@update@nextclassoffset}%
        \setcounter{hll@update@state}{1}%
        %
        \expandafter\xdef\@capturedlabel{\@val}%
    \fi
}

%    \end{macrocode}
% \subsubsection{Key `classoffset'}


%    \begin{macrocode}
\define@key{updatehighlight}{classoffset}{%
    \setcounter{hll@update@classoffset}{#1}%
    \setcounter{hll@update@state}{1}%
}
%    \end{macrocode}
% \subsubsection{Key `add'}


%    \begin{macrocode}
\define@key{updatehighlight}{add}{%
    \hll@update@add{#1}%
}

\def\hll@update@add#1{%
    \hll@update@fixclassoffset
    \def\@inv##1{\forcsvlist{\hll@update@additem{##1}}{#1}}%
    \expandafter\@inv\expandafter{\the\c@hll@update@classoffset}
    %
    \setcounter{hll@update@state}{2}%
}

\def\hll@update@additem#1#2{%
    \if\noexpand#2\relax
        \edef\keywordpure{\expandafter\@gobble\string#2}%
        \def\callwithpure##1{\hll@update@addmacro{#1}{##1}}%
        \expandafter\callwithpure\expandafter{\keywordpure}%
    \else
        \hll@update@addkeyword{#1}{#2}%
    \fi
}

\def\hll@update@addmacro#1#2{%
    \lstset{
        classoffset=0,deletetexcs={#2},
        classoffset=1,deletetexcs={#2},
        classoffset=#1,moretexcs={#2},
        classoffset=0
    }%
}

\def\hll@update@addkeyword#1#2{%
    \lstset{
        classoffset=0,deletekeywords={#2},
        classoffset=1,deletekeywords={#2},
        classoffset={#1},otherkeywords={#2},morekeywords={#2},
        classoffset=0
    }%
}

%    \end{macrocode}
% \subsubsection{Key `remove'}


%    \begin{macrocode}
\define@key{updatehighlight}{remove}{%
    \hll@update@remove{#1}%
}

\def\hll@update@remove#1{%
    \hll@update@fixclassoffset
    \def\@inv##1{\forcsvlist{\hll@update@removeitem{##1}}{#1}}%
    \expandafter\@inv\expandafter{\the\c@hll@update@classoffset}
    %
    \setcounter{hll@update@state}{2}%
}

\def\hll@update@removeitem#1#2{%
    \if\noexpand#2\relax
        \edef\keywordpure{\expandafter\@gobble\string#2}%
        \def\callwithpure##1{\hll@update@removemacro{#1}{##1}}%
        \expandafter\callwithpure\expandafter{\keywordpure}%
    \else
        \hll@update@removekeyword{#1}{#2}%
    \fi
}

\def\hll@update@removemacro#1#2{%
    \lstset{
        classoffset={#1},
        deletetexcs={#2},
        classoffset=0
    }%
}

\def\hll@update@removekeyword#1#2{%
    \lstset{
        classoffset={#1},
        deletekeywords={#2},
        classoffset=0
    }%
}

%    \end{macrocode}
% \subsubsection{Key `style'}


%    \begin{macrocode}
\define@key{updatehighlight}{style}{%
    \hll@update@fixclassoffset
    \unless\ifhllStyleAnywhere
        \ifnum\value{hll@update@state}>1\relax
            \setcounter{hll@update@state}{0}%
            \hll@update@fixclassoffset
        \fi
    \fi
    %
    \expandafter\hll@update@setstyle\expandafter{\the\c@hll@update@classoffset}{#1}%
}

\def\hll@update@setstyle#1#2{%
    \lstset{%
        classoffset={#1},
        keywordstyle={#2},
        texcsstyle={*#2},
    }%
}

%    \end{macrocode}
% \subsubsection{Key `color'}


%    \begin{macrocode}
\define@key{updatehighlight}{color}{%
    \hll@update@fixclassoffset
    \unless\ifhllStyleAnywhere
        \ifnum\value{hll@update@state}>1\relax
            \setcounter{hll@update@state}{0}%
            \hll@update@fixclassoffset
        \fi
    \fi
    %
    \expandafter\hll@update@setcolor\expandafter{\the\c@hll@update@classoffset}{#1}%
}

\def\hll@update@setcolor#1#2{%
    \lstset{%
        classoffset={#1},
        keywordstyle={\color{#2}},
        texcsstyle={*\color{#2}},
    }%
}

%    \end{macrocode}
% \subsubsection{Key `clear'}


%    \begin{macrocode}
\define@key{updatehighlight}{clear}[]{%
    \hll@update@fixclassoffset
    \expandafter\hll@update@clear\expandafter{\the\c@hll@update@classoffset}%
}

\def\hll@update@clear#1{%
    \lstset{
        classoffset={#1},
        texcs={},
        keywords={},
        classoffset=0
    }%
}
%    \end{macrocode}
%
% \Finale
%
\endinput
