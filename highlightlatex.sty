\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{highlightlatex}[2021/03/23 highlightlatex v1.0.0 + Dev]

%% Repository: https://github.com/vkuhlmann/highlight-latex
%% Version: v1.0.0 + Dev

%% Copyright (c) 2021 Vincent Kuhlmann
%%
%% Permission is hereby granted, free of charge, to any person obtaining a copy of
%% this software and associated documentation files (the "Software"), to deal in
%% the Software without restriction, including without limitation the rights to
%% use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
%% the Software, and to permit persons to whom the Software is furnished to do so,
%% subject to the following conditions:
%%
%% The above copyright notice and this permission notice shall be included in all
%% copies or substantial portions of the Software.
%%
%% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
%% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
%% FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
%% COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
%% IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
%% CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

\def\thehllversion{1.0.0 + Dev}
\newcounter{hllmajorversion}
\setcounter{hllmajorversion}{100}
\newcounter{hllminorversion}
\setcounter{hllminorversion}{\numexpr\value{hllmajorversion} * 100 + 1\relax}

\RequirePackage{listings}
\RequirePackage{xcolor}

\RequirePackage{xkeyval}
\RequirePackage{etoolbox}
\RequirePackage{adjustbox}

\def\@highlight@frame{none}
\gdef\hll@offset@fixskip{0pt}

\newif\ifhllStyleAnywhere
\newcommand\defaultgobble{0}
\newif\ifhllDebugFrame
\newlength\hllBeforeSkip
\setlength\hllBeforeSkip{2pt}
\newlength\hllAfterSkip
\setlength\hllAfterSkip{0pt}
\newif\ifhllIsInitialized
\hllIsInitializedfalse

%    \end{macrocode}
% \subsection{Package options}

%    \begin{macrocode}
\newcounter{hlltabsize}
\def\hll@alsoletter{}

%%\DeclareOptionX*{\PackageWarning{highlightlatex}{`\CurrentOption' ignored}}
%\newif\ifhll@optionnoredirect
%\newif\ifhll@redirectoption
%\let\hll@redirectto\relax
%
%\DeclareOptionX*{
%	\hll@redirectoptionfalse
%	\ifhll@optionnoredirect
%		\hll@redirectoptiontrue
%	\fi
%	\ifx\hll@redirectto\relax
%		\PackageWarning{highlightlatex}{Empty redirectto}
%		\hll@redirectoptiontrue
%	\fi
%	\ifhll@redirectoption
%		\PackageWarning{highlightlatex}{`\CurrentOption' ignored}%
%	\else
%		\hll@optionnoredirecttrue
%		%\PackageInfo{highlightlatex}{Setting `\CurrentOption'}
%		\expandafter\expandafter\hll@redirectto\expandafter{\CurrentOption}
%		\hll@optionnoredirectfalse
%	\fi
%}
%\def\hll@redirectto{\hllconfigure}

\def\hlllangname{ColoredLaTeX}
\newif\ifhll@preambleToLangDef
\hll@preambleToLangDeftrue

%\def\hll@escapeinside{~~}

%\DeclareOptionX{langname}{%
%	\def\hlllangname{#1}%
%}

%\DeclareOptionX{notildeescape}[]{%
%	\hll@tildeescapefalse
%}

% Configuration from package options
\def\hll@conffrompo{}

\DeclareOptionX*{%
	\def\mytemptemp#1{%
		\expandafter\gdef\expandafter\hll@conffrompo\expandafter{\hll@conffrompo,#1}%
	}%
	\expandafter\mytemptemp\expandafter{\CurrentOption}%
}

\ExecuteOptionsX{}
\ProcessOptionsX\relax

\catcode`\{=11
\let\@letterbraceopen={
\catcode`\{=1

\catcode`\}=11
\let\@letterbraceclose=}
\catcode`\}=2

\def\hll@definelstlanguage#1#2#3{
	%\expandafter\lstdefinelanguage\expandafter{\hlllangname}
	\lstdefinelanguage{#1}#2{
		backgroundcolor=\color{hllbackgroundcolor},
		keywordstyle=\bfseries\color{accDefault},
		basicstyle=\footnotesize\ttfamily,
		commentstyle=\color{comment},
		numbers=none,
		tabsize=4,
		mathescape=false,
		alsoletter={$@_!|?$},
		%
		classoffset=0,
		keywordstyle=\color{accDefault},
		texcsstyle=*\color{accDefault},
		moretexcs={subsection},
		deletetexcs={begin,end},
		%
		classoffset=1,
		keywordstyle=\color{accStructure},
		texcsstyle=*\color{accStructure},
		moretexcs={begin,end},
		%
		classoffset=2,
		escapeinside=~~,
		%
		classoffset=0,
		%literate={textA}{textB}{3}%
		%https://tex.stackexchange.com/questions/172945/coloring-in-listing
		literate={\{}{{\textcolor{hllbracecolor}{\@letterbraceopen}}}{1}
		{\}}{{\textcolor{hllbracecolor}{\@letterbraceclose}}}{1}
		{[}{{\textcolor{hllbracketcolor}{[}}}{1}
		{]}{{\textcolor{hllbracketcolor}{]}}}{1},
		%		{(}{{\textcolor{delimiterColor}{(}}}{1}
		%		{)}{{\textcolor{delimiterColor}{)}}}{1}%
		#3
	}
}

\ifhll@preambleToLangDef
	\def\hll@preambleaccum{}%
	\def\hll@lstset#1{%
		\expandafter\def\expandafter\hll@preambleaccum\expandafter{\hll@preambleaccum,#1}%
	}
	\AtBeginDocument{
%		\typeout{
%			Highlightlatex: preambleaccum is
%			\meaning\hll@preambleaccum
%		}

		\edef\@langdefparams{%
			{\hlllangname}%
			{[LaTeX]{TeX}}%
		}

		\def\@addlangdefparam#1{%
			\expandafter\def\expandafter\@langdefparams\expandafter{\@langdefparams {#1}}%
		}

		\expandafter\@addlangdefparam\expandafter{\hll@preambleaccum}

		\expandafter\hll@definelstlanguage\@langdefparams

		\def\@setlstlang#1{%
			\lstset{language=#1}%
		}

		\expandafter\@setlstlang\expandafter{\hlllangname}

		\def\hll@lstset#1{%
			\lstset{#1}%
		}
	}
\else
	\edef\@langdefparams{%
		{\hlllangname}%
		{[LaTeX]{TeX}}%
		{}%
	}

	\expandafter\hll@definelstlanguage\@langdefparams

	\def\@setlstlang#1{%
		\lstset{language=#1}%
	}

	\expandafter\@setlstlang\expandafter{\hlllangname}

	\def\hll@lstset#1{%
		\lstset{#1}%
	}
\fi

\newif\ifhll@ismathdollaron
\newif\ifhll@mathdollarcumulative
\hll@mathdollarcumulativetrue

\def\hll@mathdollarinnerstyle{\color{green!40!black}}
\def\hll@mathdollarouterstyle{\itshape\color{green!70!black}}
\let\hll@mathdollaroff\relax

\def\hll@mathdollarmode{outer}
\def\hll@mathdollarpalette{outer}

\define@key{hllmathdollar}{on}[]{%
	\setkeys{hllmathdollar}{\hll@mathdollarmode}
}

\define@boolkey{hllmathdollar}[hll@mathdollar@]{dollar}[true]{
	%\PackageWarning{highlightlatex}{MathInline bool dollar set. Conditional is \expandafter\meaning\csname ifhll@mathdollar@dollar\endcsname}
	\ifhll@ismathdollaron
		\setkeys{hllmathdollar}{off,on}%
	\fi
}

\define@boolkey{hllmathdollar}[hll@mathdollar@]{paren}[true]{
	%\PackageWarning{highlightlatex}{MathInline bool paren set. Conditional is \expandafter\meaning\csname ifhll@mathdollar@paren\endcsname}
	\ifhll@ismathdollaron
		\setkeys{hllmathdollar}{off,on}%
	\fi
}

%\define@boolkey{hllmathdollar}[hll@mathdollar@]{parentheses}[true]{
%	\let\ifhll@mathdollar@paren\ifhll@mathdollar@parentheses
%}

\define@key{hllmathdollar}{inner}[]{%
	\def\hll@mathdollarmode{inner}%
	\def\hll@mathdollarpalette{inner}%
	\hll@mathdollar@setinner
}

\define@key{hllmathdollar}{innerplain}[]{%
	\def\hll@mathdollarmode{innerplain}%
	\def\hll@mathdollarpalette{inner}%
	\hll@mathdollar@setinnerplain
}

\define@key{hllmathdollar}{outer}[]{%
	\def\hll@mathdollarmode{outer}%
	\def\hll@mathdollarpalette{outer}%
	\hll@mathdollar@setouter
}

\def\hll@mathdollar@setinner{%
	\hll@mathdollaroff
	\gdef\hll@mathdollaroff{%
		\hll@lstset{
			classoffset=2,
			deletedelim=**[s]{$}{$},
			deletedelim=**[s]{\(}{\)},
			classoffset=0
		}%
		\hll@ismathdollaronfalse
	}%
	\hll@lstset{classoffset=2}%
	\ifhll@mathdollar@dollar
		\hll@lstset{
			moredelim=**[s][\csname hll@mathdollar\hll@mathdollarpalette style\endcsname]{$}{$}
		}%
	\fi
	\ifhll@mathdollar@paren
		\hll@lstset{
			moredelim=**[s][\csname hll@mathdollar\hll@mathdollarpalette style\endcsname]{\(}{\)}
		}%
	\fi
	%
	\hll@lstset{classoffset=0}%
	\hll@ismathdollarontrue
}

\def\hll@mathdollar@setinnerplain{%
	\hll@mathdollaroff
	\gdef\hll@mathdollaroff{%
		\hll@lstset{
			classoffset=2,
			deletedelim=[s]{$}{$},
			deletedelim=[s]{\(}{\)},
			classoffset=0
		}%
		\hll@ismathdollaronfalse
	}%
	\hll@lstset{classoffset=2}%
	\ifhll@mathdollar@dollar
		\hll@lstset{
			moredelim=[s][\csname hll@mathdollar\hll@mathdollarpalette style\endcsname]{$}{$},
		}
	\fi
	\ifhll@mathdollar@paren
		\hll@lstset{
			moredelim=[s][\csname hll@mathdollar\hll@mathdollarpalette style\endcsname]{\(}{\)},
		}
	\fi
	%
	\hll@lstset{classoffset=0}%
	\hll@ismathdollarontrue
}


\def\hll@mathdollar@setouter{%
	\hll@mathdollaroff
	\gdef\hll@mathdollaroff{%
		\hll@lstset{
			classoffset=2,
			deletekeywords={$, $},
			deletekeywords={\(, \)},
			classoffset=0
		}%
		\hll@ismathdollaronfalse
	}%
	\hll@lstset{
		classoffset=2,
		keywordstyle={\csname hll@mathdollar\hll@mathdollarpalette style\endcsname}
	}%
	%\PackageWarning{highlightlatex}{Setting outer. Dollar conditional is \meaning\ifhll@mathdollar@dollar, paren conditional is \meaning\ifhll@mathdollar@paren}
	\ifhll@mathdollar@dollar
		\hll@lstset{
			morekeywords={$, $}
		}
	\fi
	\ifhll@mathdollar@paren
		\hll@lstset{
			morekeywords={\(, \)}
		}
	\fi
	%
	\hll@lstset{classoffset=0}%
	\hll@ismathdollarontrue
}

\define@key{hllmathdollar}{off}[]{
	\hll@mathdollaroff
}

\define@key{hllmathdollar}{style}{%
	\expandafter\def\csname hll@mathdollar\hll@mathdollarpalette style\endcsname{#1}%
}

\define@key{hllmathdollar}{color}{%
	\expandafter\def\csname hll@mathdollar\hll@mathdollarpalette style\endcsname{\color{#1}}%
}

\newcommand\hllMathDollar[1]{%
	\setkeys{hllmathdollar}{on,#1}%
}

\define@key{hllglobal}{mathdollar}[on]{%
	\hllMathDollar{#1}%
}

\define@key{hllglobal}{inlinemath}[on]{%
	\hllMathDollar{#1}%
}

\define@key{hllglobal}{frame}[]{%
	\hll@setframe{#1}%
}

\define@key{hllglobal}{noframe}[]{%
	\hll@setframe{none}%
}

\newlength\hllframerule
\setlength\hllframerule{0.6pt}

\define@key{hllglobal}{framerule}{%
	\setlength\hllframerule{#1}%
}

\define@key{hllglobal}{debugframe}[]{%
	\hllDebugFrametrue
}

\def\hll@setframe#1{%
	\def\frameval{#1}%
	\ifx\relax#1\relax
	\def\frameval{lines}%
	\fi
	\def\linesvalue{lines}%
	%
	\xdef\@highlight@frame{\frameval}%
	%
	\ifx\frameval\linesvalue
	%\gdef\hll@offset@fixskip{\dimexpr 5.651792907714846pt-\hllframerule\relax}
	%\gdef\hll@offset@fixskip{\dimexpr 5.5pt-\hllframerule\relax}
	\gdef\hll@offset@fixskip{%
		\ifdim\dimexpr 5.236pt-\hllframerule\relax>-2pt%
		\dimexpr 5.236pt-\hllframerule\relax
		\else
		\dimexpr -2pt\relax
		\fi
	}
	\else
	\gdef\hll@offset@fixskip{-2pt}%
	\fi
	\PackageInfo{highlightlatex}{Test}
}

\define@key{hllglobal}{styleanywhere}{
	\hllStyleAnywheretrue
}

\define@key{hllglobal}{tabsize}{%
	\setcounter{hlltabsize}{#1}%
	\hll@lstset{tabsize=#1}%
}

\define@key{hllglobal}{mathdollarstyle}[]{%
	\ifx\relax#1\relax
		\hllDelimDollar
	\else
		\hllDelimDollar[#1]%
	\fi
}

\define@key{hllglobal}{mathdollarcolor}[]{%
	\ifx\relax#1\relax
		\hllDelimDollar%
	\else
		\hllDelimDollar[\color{#1}]%
	\fi
}

\define@key{hllglobal}{mathparenstyle}[]{%
	\ifx\relax#1\relax
		\hllDelimParen
	\else
		\hllDelimParen[#1]%
	\fi
}
\define@key{hllglobal}{mathparencolor}[]{%
	\ifx\relax#1\relax
		\hllDelimParen
	\else
		\hllDelimParen[\color{#1}]%
	\fi
}

\define@key{hllglobal}{gobble}{%
	\def\defaultgobble{#1}%
}

\define@key{hllglobal}{gobbletabs}{%
	\def\defaultgobble{\numexpr\value{hlltabsize} * (#1)\relax}%
}

\define@key{hllglobal}{alsoletter}{%
	\def\hll@alsoletter{#1}%
	\hll@lstset{alsoletter={#1}}%
}

\define@key{hllglobal}{backgroundcolor}{%
	\colorlet{hllbackgroundcolor}{#1}%
}

\define@key{hllglobal}{bracecolor}{%
	\colorlet{hllbracecolor}{#1}%
}

\define@key{hllglobal}{bracketcolor}{%
	\colorlet{hllbracketcolor}{#1}%
}

\define@key{hllglobal}{commentcolor}{%
	\colorlet{comment}{green!40!black}%
}

\newcommand{\hllconfigure}[1]{%
	\setkeys{hllglobal}{#1}%
}

\newcommand{\hllConfigure}[1]{%
	\hllconfigure{#1}%
}

%\def\hll@processpackageoptions#1{%
%	\setkeys*{hllpackageoption}{#1}%
%	%\global\let\hll@conffrompo\XKV@rm
%	%\def\XKV@rm{}%
%}

%\expandafter\hll@processpackageoptions\expandafter{\csname opt@\@currname.\@currext\endcsname}
%\AtEndOfPackage{\let\@unprocessedoptions\relax}

%\let\hll@redirectto\relax

%    \end{macrocode}
% \subsection{Initialization}

%    \begin{macrocode}
\colorlet{hllbackgroundcolor}{white}
\colorlet{accDefault}{blue!90!black}
\definecolor{accStructure}{RGB}{0,149,255}
\colorlet{comment}{green!40!black}
\colorlet{hllbracecolor}{black}
\colorlet{hllbracketcolor}{black}

\hllConfigure{
	frame=lines,
	tabsize=4,
	gobble=0,
	backgroundcolor=gray!6!white,
	bracecolor=red!50!blue,
	bracketcolor=blue!50!white,
	commentcolor=green!40!black,
	alsoletter={$@_!|?$},
	inlinemath={
		inner,
		color={green!40!black},
		%
		outer,
		style={\itshape\color{green!70!black}},
		%
		dollar=true,
		paren=true,
		outer%, inner, innerplain, off
	}
}

\PackageWarning{higlightlatex}{Rmkeys are (\hll@conffrompo)}
%\let\XKV@rm\hll@conffrompo

\expandafter\hllconfigure\expandafter{\hll@conffrompo}

%\setrmkeys{hllglobal}

\def\hll@setalsoletter#1{%
	\hll@lstset{alsoletter={#1}}%
}

\expandafter\hll@setalsoletter\expandafter{\hll@alsoletter}

\def\hll@assignlabel#1#2{%
	\expandafter\gdef\csname hll@labeltoclassoffset@#1\endcsname{#2}%
}

\hll@assignlabel{default}{0}
\hll@assignlabel{structure}{1}

\hllIsInitializedtrue

%    \end{macrocode}
% \subsection{Options}
%
%    \begin{macrocode}

%    \end{macrocode}
% \subsection{Block and inline markup}
%
%%% =========================
%%%   block & inline markup
%%% =========================
%%%
%    \begin{macrocode}
\define@key{hllblock}{gobbletabs}
{
	\hll@lstset{gobble=\numexpr\value{hlltabsize} * (#1)\relax}
}

\define@choicekey{hllblock}{style}[\val\nr]{tight,normal,spacious}
{%
	\ifcase\nr\relax
		\setlength\hllBeforeSkip{0pt}%
		\setlength\hllAfterSkip{0pt}%
	\or
		\setlength\hllBeforeSkip{4pt}%
		\setlength\hllAfterSkip{0pt}%
	\or
		\setlength\hllBeforeSkip{\baselineskip}%
		\setlength\hllAfterSkip{1.5\baselineskip}%
	\fi
}

\newcommand\hll@blockset[1]{%
	\setkeys*{hllblock}{#1}%
	\expandafter\hll@lstset\expandafter{\XKV@rm}%
}

\newcommand{\hllPrepareBlock}
{%
	\hll@lstset{framesep=0.1cm,framerule=\hllframerule}%
	\def\setHighlightFrame##1{%
		\hll@lstset{frame=##1}%
	}%
	\expandafter\setHighlightFrame\expandafter{\@highlight@frame}%
	\hll@lstset{belowskip=0pt,aboveskip=0pt,belowcaptionskip=0pt,gobble=\defaultgobble}%
	\setlength\parskip{0pt}%
	\setlength\parindent{0pt}%
}

\def\hll@blockbegin#1{
	\begingroup
	\hllPrepareBlock
	\hll@blockset{style=normal,#1}%
	\vspace{\hllBeforeSkip}%
}

\def\hll@blockend#1{
	\nointerlineskip
	\vspace{\hllAfterSkip}%
	\endgroup
	%\leavevmode
}

\lstnewenvironment{highlightblock}[1][]
{%
	\hll@blockbegin{#1}%
}{%
	\hll@blockend{#1}%
}

\lstnewenvironment{hllblock}[1][]
{%
	\hll@blockbegin{#1}%
}{%
	\hll@blockend{#1}%
}

\def\hll{\lstinline}

%    \end{macrocode}
% \subsection{Block saving}

%%% ================
%%%   block saving
%%% ================

%    \begin{macrocode}
\newenvironment{saveblock}[1]{%
	\expandafter\ifx\csname @codebox@#1\endcsname\relax
		\expandafter\newbox\csname @codebox@#1\endcsname\relax
	\fi
	%
	%% The trick from latex/base/latex.ltx
	\edef\@bracehack{%
		\endgroup
		\expandafter\setbox\csname @codebox@#1\endcsname\vbox{%
			\begingroup\aftergroup}%
		\def\noexpand\@currenvir{\@currenvir}%
		\def\noexpand\@currenvline{\on@line}}%
	\@bracehack
	\edef\aa{\hll@offset@fixskip}
	\PackageWarning{highlightlatex}{aa: \meaning\aa}

	\begingroup\vspace{\hll@offset@fixskip}
	\ignorespaces%
}{%
	\endgroup
}

\newcommand\useblock[1]{%
	\ifhllDebugFrame
		\par
		{%
			%\setlength{\fboxsep}{0pt}%
			%\fcolorbox{orange}{red}{\expandafter\usebox\csname @codebox@#1\endcsname}%
			\adjustbox{cfbox=orange 2pt 0pt,valign=t,bgcolor=yellow}{%
				\adjustbox{lap=-10pt}{%
					\expandafter\usebox\csname @codebox@#1\endcsname
				}%
			}
		}%
		\par
	\else
		\par\expandafter\usebox\csname @codebox@#1\endcsname\par
	\fi
}

\newcommand\consumeblock[1]{%
	\ifhllDebugFrame
		\par
		{%
			\setlength{\fboxsep}{0pt}%
			\setlength{\fboxrule}{1pt}%
			\fcolorbox{orange}{red}{\leavevmode\expandafter\box\csname @codebox@#1\endcsname\relax}%
		}
		\par
		\expandafter\let\csname @codebox@#1\endcsname\relax
	\else
		\par\leavevmode\expandafter\box\csname @codebox@#1\endcsname\relax\par
		\expandafter\let\csname @codebox@#1\endcsname\relax
	\fi
}

%    \end{macrocode}
% \subsection{Macro \textbackslash updatehighlight}

%%% ===================
%%%   updatehighlight
%%% ===================

%    \begin{macrocode}
\def\hll@update@label{}

\newcounter{hll@update@state}

\newcounter{hll@update@nextclassoffset}
\setcounter{hll@update@nextclassoffset}{5}

\newcounter{hll@update@classoffset}

\def\hll@update@fixclassoffset{%
	\ifnum\value{hll@update@state}<1\relax
	\setcounter{hll@update@classoffset}{\thehll@update@nextclassoffset}%
	\stepcounter{hll@update@nextclassoffset}%
	\setcounter{hll@update@state}{1}%
	\fi
}

\newcommand{\updatehighlight}[1]{%
	\setcounter{hll@update@state}{-1}%
	\gdef\hll@update@label{}%
	\setkeys{updatehighlight}{#1}%
	%
	\hll@lstset{classoffset=0}%
}

\newcommand{\hllupdaterules}[1]{%
	\updatehighlight{#1}%
}

\newcommand{\hllUpdateRules}[1]{%
	\updatehighlight{#1}%
}

%    \end{macrocode}
% \subsubsection{Key `name'}

%%% KEY: name
%%% ---------

%    \begin{macrocode}
\define@key{updatehighlight}{name}{%
	\hll@update@setlabel{#1}%
}

\def\hll@update@setlabel#1{
	\gdef\hll@update@label{#1}%
	\expandafter\def\expandafter\@capturedlabel\expandafter{\csname hll@labeltoclassoffset@#1\endcsname}%
	\expandafter\unless\expandafter\ifx\@capturedlabel\relax\relax
		% Label exists
		\edef\@val{\@capturedlabel}%
		\setcounter{hll@update@classoffset}{\@val}%
		\setcounter{hll@update@state}{1}%
	\else
		% Allocate new label
		\edef\@val{\thehll@update@nextclassoffset}%
		\setcounter{hll@update@classoffset}{\@val}%
		\stepcounter{hll@update@nextclassoffset}%
		\setcounter{hll@update@state}{1}%
		%
		\expandafter\xdef\@capturedlabel{\@val}%
	\fi
}

%    \end{macrocode}
% \subsubsection{Key `classoffset'}

%%% KEY: classoffset
%%% ----------------

%%%    \begin{highlightblock}[numbers=left,firstnumber=last]
%%% ~{\makeatletter\meaning\lstenv@endstring\expandafter\def\expandafter\lstenv@endstring\expandafter{\lstenv@endstring a}}~
%    \begin{macrocode}
\define@key{updatehighlight}{classoffset}{%
	\setcounter{hll@update@classoffset}{#1}%
	\setcounter{hll@update@state}{1}%
}
%    \end{macrocode}
%%%~\iffalse
%%%    \fi~\end{highlightblock}
%%% \end{highlightblock}aaa
% \subsubsection{Key `add'}

%%% KEY: add
%%% --------

%    \begin{macrocode}
\define@key{updatehighlight}{add}{%
	\hll@update@add{#1}%
}

\def\hll@update@add#1{%
	\hll@update@fixclassoffset
	\def\@inv##1{\forcsvlist{\hll@update@additem{##1}}{#1}}%
	\expandafter\@inv\expandafter{\the\c@hll@update@classoffset}
	%
	\setcounter{hll@update@state}{2}%
}

\def\hll@update@additem#1#2{%
	\if\noexpand#2\relax
		\edef\keywordpure{\expandafter\@gobble\string#2}%
		\def\callwithpure##1{\hll@update@addmacro{#1}{##1}}%
		\expandafter\callwithpure\expandafter{\keywordpure}%
	\else
		\hll@update@addkeyword{#1}{#2}%
	\fi
}

\def\hll@update@addmacro#1#2{%
	\hll@lstset{
		classoffset=0,deletetexcs={#2},
		classoffset=1,deletetexcs={#2},
		classoffset=#1,moretexcs={#2},
		classoffset=0
	}%
}

\def\hll@update@addkeyword#1#2{%
	\hll@lstset{
		classoffset=0,deletekeywords={#2},
		classoffset=1,deletekeywords={#2},
		classoffset={#1},otherkeywords={#2},morekeywords={#2},
		classoffset=0
	}%
}

%    \end{macrocode}
% \subsubsection{Key `remove'}

%%% KEY: remove
%%% -----------

%    \begin{macrocode}
\define@key{updatehighlight}{remove}{%
	\hll@update@remove{#1}%
}

\def\hll@update@remove#1{%
	\hll@update@fixclassoffset
	\def\@inv##1{\forcsvlist{\hll@update@removeitem{##1}}{#1}}%
	\expandafter\@inv\expandafter{\the\c@hll@update@classoffset}
	%
	\setcounter{hll@update@state}{2}%
}

\def\hll@update@removeitem#1#2{%
	\if\noexpand#2\relax
		\edef\keywordpure{\expandafter\@gobble\string#2}%
		\def\callwithpure##1{\hll@update@removemacro{#1}{##1}}%
		\expandafter\callwithpure\expandafter{\keywordpure}%
	\else
		\hll@update@removekeyword{#1}{#2}%
	\fi
}

\def\hll@update@removemacro#1#2{%
	\hll@lstset{
		classoffset={#1},
		deletetexcs={#2},
		classoffset=0
	}%
}

\def\hll@update@removekeyword#1#2{%
	\hll@lstset{
		classoffset={#1},
		deletekeywords={#2},
		classoffset=0
	}%
}

%    \end{macrocode}
% \subsubsection{Key `style'}

%%% KEY: style
%%% ----------

%    \begin{macrocode}
\define@key{updatehighlight}{style}{%
	\hll@update@fixclassoffset
	\unless\ifhllStyleAnywhere
		\ifnum\value{hll@update@state}>1\relax
			\setcounter{hll@update@state}{0}%
			\hll@update@fixclassoffset
		\fi
	\fi
	%
	\expandafter\hll@update@setstyle\expandafter{\the\c@hll@update@classoffset}{#1}%
}

\def\hll@update@setstyle#1#2{%
	\hll@lstset{%
		classoffset={#1},
		keywordstyle={#2},
		texcsstyle={*#2},
	}%
}

%    \end{macrocode}
% \subsubsection{Key `color'}

%%% KEY: color
%%% ----------

%    \begin{macrocode}
\define@key{updatehighlight}{color}{%
	\hll@update@fixclassoffset
	\unless\ifhllStyleAnywhere
		\ifnum\value{hll@update@state}>1\relax
			\setcounter{hll@update@state}{0}%
			\hll@update@fixclassoffset
		\fi
	\fi
	%
	\expandafter\hll@update@setcolor\expandafter{\the\c@hll@update@classoffset}{#1}%
}

\def\hll@update@setcolor#1#2{%
	\hll@lstset{%
		classoffset={#1},
		keywordstyle={\color{#2}},
		texcsstyle={*\color{#2}},
	}%
}

%    \end{macrocode}
% \subsubsection{Key `clear'}

%%% KEY: clear
%%% ----------

%    \begin{macrocode}
\define@key{updatehighlight}{clear}[]{%
	\hll@update@fixclassoffset
	\expandafter\hll@update@clear\expandafter{\the\c@hll@update@classoffset}%
}

\def\hll@update@clear#1{%
	\hll@lstset{
		classoffset={#1},
		texcs={},
		keywords={},
		classoffset=0
	}%
}



