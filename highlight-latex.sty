\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{highlight-latex}[2021/03/13]

% Copyright (c) 2021 Vincent Kuhlmann
% 
% Permission is hereby granted, free of charge, to any person
% obtaining a copy of this software and associated documentation
% files (the "Software"), to deal in the Software without
% restriction, including without limitation the rights to use,
% copy, modify, merge, publish, distribute, sublicense, and/or sell
% copies of the Software, and to permit persons to whom the
% Software is furnished to do so, subject to the following
% conditions:
% 
% The above copyright notice and this permission notice shall be
% included in all copies or substantial portions of the Software.
% 
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
% OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
% NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
% HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
% WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
% FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
% OTHER DEALINGS IN THE SOFTWARE.

\RequirePackage{listings}

%\usepackage{textcomp}

\RequirePackage{xcolor}
%\RequirePackage{color}

\RequirePackage{xkeyval}
\RequirePackage{etoolbox}

\def\@highlight@frame{none}
\newif\ifhllAllowLateStyle

\DeclareOptionX{frame}{
	%\typeout{Frame option was supplied}
	\ifx\relax#1\relax
		\gdef\@highlight@frame{lines}
		%\typeout{Frame without value}
	\else
		\gdef\@highlight@frame{#1}
		%\typeout{Frame was supplied with value #1}
	\fi
}

\DeclareOptionX{latestyle}{
	\hllAllowLateStyletrue
}

\DeclareOptionX*{\PackageWarning{highlight-latex}{`\CurrentOption' ignored}}
\ExecuteOptionsX{}

\ProcessOptionsX\relax


\colorlet{curlyBrackets}{red!50!blue}
\colorlet{squareBrackets}{blue!50!white}

\definecolor{accA}{RGB}{0,149,255}
\colorlet{accB}{green!60!black}
\colorlet{accC}{red!60!black}
\colorlet{accD}{orange!100!black}
\colorlet{accE}{green!60!black}
\colorlet{accF}{green!60!black}

\colorlet{accDefault}{blue!90!black}

\colorlet{codeBackground}{gray!10!white}

\lstset{
	classoffset=0,
	backgroundcolor=\color{codeBackground},
	keywordstyle=\bfseries\color{accDefault},
	basicstyle=\footnotesize\ttfamily,
	commentstyle=\color{green!40!black},
	numbers=none,
	tabsize=2
}

\catcode`\{=11
\let\myopenbrace={
\catcode`\{=1

\catcode`\}=11
\let\myclosebrace=}
\catcode`\}=2

\lstdefinelanguage{ColoredLaTeX}
[LaTeX]{TeX}{
	classoffset=0,
	moretexcs={subsection,thesubsection,thesection,greek,Greek,Nwords,enumbinary,foreignlanguage,theoremstyle},
%	
	classoffset=1,
%	otherkeywords={->,=>},
%	morekeywords={aaaaa,iiiis,->,=>},
	keywordstyle=\color{red},
	%classoffset=0,
	%moretexcs={commandinred},
	texcsstyle=*\color{red},
%
	classoffset=2,
	texcsstyle=*\color{green},
%	
	classoffset=3,
	texcsstyle=*\color{blue},
% cmdA
	classoffset=4,
	keywordstyle=\color{accA},
	texcsstyle=*\color{accA},
% cmdB
	classoffset=5,
	keywordstyle=\color{accB},
	texcsstyle=*\color{accB},
% cmdC
	classoffset=6,
	keywordstyle=\color{accC},
	texcsstyle=*\color{accC},
% cmdD
	classoffset=7,
	keywordstyle=\color{accD},
	texcsstyle=*\color{accD},
% cmdE
	classoffset=8,
	keywordstyle=\color{accD},
	texcsstyle=*\color{accD},
% cmdF
	classoffset=9,
	keywordstyle=\color{accD},
	texcsstyle=*\color{accD},
%
	classoffset=20,	
	%keywordstyle=\color{white},
	%	otherkeywords={\{,\}},
	%	morekeywords=[2]{\{,\}},
	%	otherkeywords={\{}
	%morekeywords={\{,\},\[,\]},
	keywordstyle=\color{blue!50!white},
%	
	classoffset=21,
	%moredelim=[s][\bfseries\color{green!30!black}]{!}{!},
	%moredelim=[is][\space]{~}{~},
	escapeinside=~~,
%	
	classoffset=0,
	%literate={daag}{hey}{3}%
	%https://tex.stackexchange.com/questions/172945/coloring-in-listing
	literate={\{}{{\textcolor{curlyBrackets}{\myopenbrace}}}{1}
		{\}}{{\textcolor{curlyBrackets}{\myclosebrace}}}{1}
		{[}{{\textcolor{squareBrackets}{[}}}{1}
		{]}{{\textcolor{squareBrackets}{]}}}{1}%
	%		{(}{{\textcolor{delimiterColor}{(}}}{1}
	%		{)}{{\textcolor{delimiterColor}{)}}}{1}%
	%texcsstyle=\color{blue}
}
\lstset{language=ColoredLaTeX}

\newcommand\cmdDefault[1]{\lstset{moretexcs={#1}}}
\newcommand\cmdRed[1]{\lstset{classoffset=1,moretexcs={#1},classoffset=0}}
\newcommand\cmdGreen[1]{\lstset{classoffset=2,moretexcs={#1},classoffset=0}}
\newcommand\cmdPurple[1]{\lstset{classoffset=3,moretexcs={#1},texcsstyle=*\color{purple},classoffset=0}}

\newcommand\cmdA[1]{\lstset{deletetexcs={#1},classoffset=4,moretexcs={#1},classoffset=0}}
\newcommand\cmdB[1]{\lstset{deletetexcs={#1},classoffset=5,moretexcs={#1},classoffset=0}}
\newcommand\cmdC[1]{\lstset{deletetexcs={#1},classoffset=6,moretexcs={#1},classoffset=0}}
\newcommand\cmdD[1]{\lstset{deletetexcs={#1},classoffset=7,moretexcs={#1},classoffset=0}}
\newcommand\cmdE[1]{\lstset{deletetexcs={#1},classoffset=8,moretexcs={#1},classoffset=0}}
\newcommand\cmdF[1]{\lstset{deletetexcs={#1},classoffset=9,moretexcs={#1},classoffset=0}}

\newcommand\highlightA[1]{\lstset{deletekeywords={#1},classoffset=4,otherkeywords={#1},morekeywords={#1},classoffset=0}}
\newcommand\highlightB[1]{\lstset{deletekeywords={#1},classoffset=5,otherkeywords={#1},morekeywords={#1},classoffset=0}}
\newcommand\highlightC[1]{\lstset{deletekeywords={#1},classoffset=6,otherkeywords={#1},morekeywords={#1},classoffset=0}}
\newcommand\highlightD[1]{\lstset{deletekeywords={#1},classoffset=7,otherkeywords={#1},morekeywords={#1},classoffset=0}}
\newcommand\highlightE[1]{\lstset{deletekeywords={#1},classoffset=8,otherkeywords={#1},morekeywords={#1},classoffset=0}}
\newcommand\highlightF[1]{\lstset{deletekeywords={#1},classoffset=9,otherkeywords={#1},morekeywords={#1},classoffset=0}}

\cmdA{begin}
\cmdA{end}

\newbox\codebox
\newbox\codeboxB
\newbox\codeboxC
\newbox\codeboxD
\newbox\codeboxE

%\cmdRed{dadada}
%\cmdGreen{bababa}
%\cmdPurple{uwuwuwu}

%\newcommand\colorcmd[2]{\lstset{classoffset=3,moretexcs={#2},texcsstyle=*\color{#1},classoffset=0}}

\colorlet{grayCodeBackground}{gray!10!white}

\newcommand{\higlightLight}{%
	\colorlet{codeBackground}{grayCodeBackground}%
	\lstset{framesep=0.1cm,framerule=0.6pt}%
	\def\setHighlightFrame##1{%
		\lstset{frame=##1}%
	}%
	\expandafter\setHighlightFrame\expandafter{\@highlight@frame}%
}

\newcommand\defaultgobble{4}

\lstnewenvironment{latexlight}[1][]
{\begingroup\higlightLight\lstset{belowskip=0pt,gobble=\defaultgobble}\lstset{#1}}{\endgroup}

\def\newcodebox#1{%
	\expandafter\newbox\csname #1\endcsname
	\expandafter\def\csname use#1\endcsname{%
		\par\expandafter\usebox\csname #1\endcsname\par	
	}%
}

\newcodebox{codebox}
\newcodebox{codeboxB}
\newcodebox{codeboxC}
\newcodebox{codeboxD}
\newcodebox{codeboxE}


\def\@highlight@latex@label{}

\newcounter{hll@update@state}

\newcounter{highlight@latex@nextclassoffset}
\setcounter{highlight@latex@nextclassoffset}{22}

\newcounter{highlight@latex@classoffset}

\define@key{updatehighlight}{label}{%
	\gdef\@highlight@latex@label{#1}%
	\expandafter\def\expandafter\@capturedlabel\expandafter{\csname @highlight@latex@label@#1\endcsname}%
	\expandafter\unless\expandafter\ifx\@capturedlabel\relax\relax
		% Label exists
		\edef\@val{\@capturedlabel}%
		\setcounter{highlight@latex@classoffset}{\@val}%
		\setcounter{hll@update@state}{1}%
	\else
		% Allocate new label
		\edef\@val{\thehighlight@latex@nextclassoffset}%
		\setcounter{highlight@latex@classoffset}{\@val}%
		\stepcounter{highlight@latex@nextclassoffset}%
		\setcounter{hll@update@state}{1}%
		%
		\expandafter\xdef\@capturedlabel{\@val}%
	\fi
}

\define@key{updatehighlight}{classoffset}{%
	\setcounter{highlight@latex@classoffset}{#1}%
	\setcounter{hll@update@state}{1}%
}

\define@key{updatehighlight}{macros}{%
	\hll@update@macros{#1}%
}

\define@key{updatehighlight}{commands}{%
	\hll@update@macros{#1}%
}

\define@key{updatehighlight}{style}{%
	\hll@update@fixclassoffset
	\unless\ifhllAllowLateStyle
		\ifnum\value{hll@update@state}>1\relax
			\setcounter{hll@update@state}{0}%
			\hll@update@fixclassoffset
		\fi
	\fi
	%
	\expandafter\hll@update@setstyle\expandafter{\the\c@highlight@latex@classoffset}{#1}%
}

\define@key{updatehighlight}{color}{%
	\hll@update@fixclassoffset
	\unless\ifhllAllowLateStyle
		\ifnum\value{hll@update@state}>1\relax
			\setcounter{hll@update@state}{0}%
			\hll@update@fixclassoffset
		\fi
	\fi
	%
	\expandafter\hll@update@setcolor\expandafter{\the\c@highlight@latex@classoffset}{#1}%
}

\define@key{updatehighlight}{keywords}{%
	\hll@update@keywords{#1}%
}

\def\hll@update@macros#1{%
	\hll@update@fixclassoffset
	\def\@inv##1{\forcsvlist{\hll@update@addmacro{##1}}{#1}}%
	\expandafter\@inv\expandafter{\the\c@highlight@latex@classoffset}
	%
	\setcounter{hll@update@state}{2}%
}

\def\hll@update@addmacro#1#2{%
	\if\noexpand#2\relax
		\edef\keywordpure{\expandafter\@gobble\string#2}%
		%(Keywords is \meaning\keywordpure)%
		\def\callwithpure##1{\hll@update@addmacro@i{#1}{##1}}%
		\expandafter\callwithpure\expandafter{\keywordpure}%
	\else
		\hll@update@addmacro@i{#1}{#2}%
	\fi
}

\def\hll@update@addmacro@i#1#2{%
	\lstset{deletetexcs={#2},classoffset=#1,moretexcs={#2},classoffset=0}%
}

\def\hll@update@keywords#1{%
	\hll@update@fixclassoffset
	\def\@inv##1{\forcsvlist{\hll@update@addkeyword{##1}}{#1}}%
	\expandafter\@inv\expandafter{\the\c@highlight@latex@classoffset}%
	%
	\setcounter{hll@update@state}{2}%
}

\def\hll@update@addkeyword#1#2{%
	\lstset{deletetexcs={#2},classoffset=#1,otherkeywords={#2},morekeywords={#2},classoffset=0}%
}

%%

\def\hll@update@fixclassoffset{%
	\ifnum\value{hll@update@state}<1\relax
		\setcounter{highlight@latex@classoffset}{\thehighlight@latex@nextclassoffset}%
		\stepcounter{highlight@latex@nextclassoffset}%
		\setcounter{hll@update@state}{1}%
	\fi
}

\def\hll@update@setcolor#1#2{%
	\lstset{%
		classoffset=#1,
		keywordstyle={\color{#2}},
		texcsstyle={*\color{#2}},
	}%
}

\def\hll@update@setstyle#1#2{%
	\lstset{%
		classoffset=#1,
		keywordstyle={#2},
		texcsstyle={*#2},
	}%
}

\newcommand{\updatehighlight}[1]{%
	\setcounter{hll@update@state}{-1}%
	\gdef\@highlight@latex@label{}%
	\setkeys{updatehighlight}{#1}%
	%
	\hll@update@fixclassoffset
}


